# Ферма

Self-hosted сервис для развертывания приложений из пулл-реквестов.

# Как это работает?

**CI**

- Создайте Pull Request
- Отправьте веб-хук в FarmAPI для создания нового инстанса

**Farm**

- Скачает код
- Выполнит сборку
- Запустит инстанс

**CI**

- Запросите из FarmAPI текущий статус инстанса
- Получите URL инстанса, когда он будет готов
- Используйте собранный инстанс для запуска E2E-тестов

<img src="../assets/network-schema-01.svg" alt="Network Schema" width="500"/>

Общая схема доступа к ресурсам.
Итоговый вариант может быть чуть сложнее и зависит от выбранной конфигурации.

## Провайдеры

Ферма поддерживает следующие провайдеры:

- Docker
- Kubernetes (k8s)

От выбранного провайдера зависит сложность инфраструктуры и возможности масштабирования.

**Docker**

При использовании docker-провайдера ферма сможет работать только на одной виртуальной машине. Балансировщик, сервис фермы и собранные инстансы будут использовать ресурсы одной виртуальной машины.

Это экономичный и простой вариант для небольших команд.

Рекомендуется ограничить количество параллельных сборок или выполнять не более одной сборки одновременно.

Текущие ограничения:
- Частичная поддержка BuildKit (некоторые функции могут не работать)
- Не поддерживаются функции монтирования файлов и каталогов (включая секреты и аналогичные функции)

**Kubernetes (k8s)**

При использовании k8s компоненты фермы, включая инстансы и процессы их сборки, запускаются независимо друг от друга. В таком варианте ферма сможет масштабироваться горизонтально.

# Начало работы

Рекомендуем начать с развёртывания одной из тестовых конфигураций фермы, а затем настроить ферму для своих проектов.

- [Ферма с использованием Docker](../../base-environments/docker-provider-farm/README.md)

# Конфигурации

Настройте ферму под свои проекты:

- Конфигурация фермы [`farm-config.json`](./farm-config-json.md)
  - Описание конфигураций провайдеров
    - [Docker](./farm-config-json-docker-provider.md)
    - [K8s](./farm-config-json-k8s-provider.md)
- Конфигурация сборки приложения в ферме [`farm.json`](./farm-json.md)

# Continuous Integration

[Читать как настроить Ферму в CI для генерации инстансов приложений](./ci.md)

# Безопасность

На текущий момент Ферма не имеет механизмов ограничения доступа к инстансам и UI/API Фермы. Рекомендуем разворачивать Ферму в контролируемом окружении и ограничить доступ на уровне сети.

Ограничение доступа появится позже.
